<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />

<style type="text/css">
		html {
				margin: 0;
				padding: 0;
				background-color: rgba(0,0,0,0.01);
		}
		body {
				margin: 0;
				padding: 0;
		}
		#editor {
				position: absolute;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
		}
		
		
		.pace {
		  -webkit-pointer-events: none;
		  pointer-events: none;

		  -webkit-user-select: none;
		  -moz-user-select: none;
		  user-select: none;
		}

		.pace-inactive {
		  display: none;
		}

		.pace .pace-progress {
		  background: #99fe01;
		  position: fixed;
		  z-index: 2000;
		  top: 0;
		  right: 100%;
		  width: 100%;
		  height: 2px;
		}

		
</style>

<script src='http://cdn.jsdelivr.net/pace/1.0.2/pace.min.js'></script>

</head>
<body>

<div id="editor"></div>
<!-- <div id="statusBar">asdasd</div> -->
<script>
	var DEBUG = false;
	if (location.pathname.indexOf("debug")>=0) {
		DEBUG = true;
		console.log("=== debug mode ===");
		(function() {
			var js = document.createElement("script");
			js.type = "text/javascript";
			js.src = "live.js";
			document.body.appendChild(js);
		})();
	}
	
</script>

<script src="asset://garrysmod/data/tmp_autocomplete.dat"></script>

<script src="ace/ace.js"></script>
<script src="ace/ext-elastic_tabstops_lite.js"></script>
<!--  <script src="ace/ext-emmet.js"></script> -->
<script src="ace/ext-language_tools.js"></script>
<script src="ace/ext-keybinding_menu.js"></script>
<script src="ace/ext-modelist.js"></script>
<script src="ace/ext-searchbox.js"></script>
<script src="ace/ext-settings_menu.js"></script>
<!--  <script src="ace/ext-spellcheck.js"></script> -->
<!--<script src="ace/ext-static_highlight.js"></script> -->
<!-- <script src="ace/ext-statusbar.js"></script> -->
<script src="ace/ext-textarea.js"></script>
<script src="ace/ext-themelist.js"></script>
<script src="ace/ext-whitespace.js"></script>
<script src="ace/keybinding-emacs.js"></script>
<script src="ace/keybinding-vim.js"></script>
<script src="ace/worker-coffee.js"></script>
<script src="ace/worker-css.js"></script>
<script src="ace/worker-javascript.js"></script>
  <script src="ace/worker-json.js"></script> 
<!--    <script src="ace/worker-php.js"></script> -->
<!--  <script src="ace/worker-xquery.js"></script> -->
<script src="ace/mode-text.js"></script>
<script src="ace/snippets/text.js"></script>
<script src="ace/mode-lua.js"></script>
<script src="ace/snippets/lua.js"></script>
<script src="ace/mode-glua.js"></script>
<script src="ace/snippets/glua.js"></script>

<script>
	var editor = ace.edit("editor");
	
	ace.require("ace/ext/language_tools");
	ace.require('ace/ext/settings_menu').init(editor);
	ace.require('ace/ext/keybinding_menu').init(editor);
	
	//var StatusBar = ace.require("ace/ext/statusbar").StatusBar;
	//var statusBar = new StatusBar(editor, document.getElementById("statusBar"));
	
	if ("gmodinterface" in window) {
		
		editor.container.addEventListener("contextmenu", function(e) {
			console.log("preventing right click");
			e.preventDefault();
			return false;
		}, false);
		
	}
	
	editor.setOptions({
			enableBasicAutocompletion: true,
			enableSnippets: true,
			//enableLiveAutocompletion: true, 
			scrollPastEnd: true
	});
	var s_id=0;
	function DisableShortcut(scut) {
		s_id++;
		editor.commands.addCommands([{
			name: "dis"+s_id,
			bindKey: {
					win: scut,
					mac: scut
			},
			exec: function(editor, line) {
					return false;
			},
			readOnly: true
		}]);
	};
	DisableShortcut("Ctrl-Alt+0");

	editor.getSession().setUseWrapMode(false);
	editor.getSession().setUseSoftTabs(false);
	editor.setHighlightActiveLine(true);
	editor.setShowPrintMargin(false);

	editor.setTheme("ace/theme/monokai");
	
	
	editor.getSession().setMode("ace/mode/lua");
	//try {
		editor.getSession().setMode("ace/mode/glua");
	//} catch (e) {
	//	console.log("Deferring to lua mode");
	//	editor.getSession().setMode("ace/mode/lua");
	//	throw e;
	//}
	
	editor.$blockScrolling = Infinity;
		
		
</script>

<script>
		
		editor.focus();

		// callbacks

		// lua->js
		function SetTheme(themename) {
			//OnLog("SetTheme "+themename);
			editor.setTheme("ace/theme/"+themename);
		}
		
		function SetOption(k,v) {
			var opts = {}; opts[k]=v;
			editor.setOptions(opts);
		}

		function GetOptions() {
			try {
				if ("gmodinterface" in window) {
					var str = JSON.stringify(editor.getOptions());
					gmodinterface.GetOptions(str);
				}
			} catch (err) {
				console.log("ERR OnCode: "+err);
			}
		}
		
		function SetOptions(str) {
			var opts = JSON.parse(str);
			editor.setOptions(opts);
		}
		
		function SetFontSize(sz) {
			//OnLog("SetFontSize "+sz);
			document.getElementById('editor').style.fontSize=sz+'px';
		}
		function SetMode(editormode) {
			//OnLog("SetMode "+editormode);
			editor.getSession().setMode("ace/mode/"+editormode);
		}
		function GotoLine(linenum) {
			//OnLog("GotoLine "+linenum);
			editor.gotoLine(linenum);
		}
		function SetContent(code) {
			//OnLog("SetContent "+code);
			editor.getSession().getDocument().setValue(code);
		}
		function SetErr(errline,errstr) {
			//OnLog("SetErr "+errstr);
			editor.getSession().setAnnotations([{row: errline - 1, text: errstr, type: "error"}]);
		}
		function ClearErr() {
			//OnLog("ClearErr");
			editor.getSession().clearAnnotations();
		}
		function ShowMenu() {
			//OnLog("ShowMenu");
			editor.showSettingsMenu();
		}
		function ShowBinds() {
			//OnLog("ShowBinds");
			editor.showKeyboardShortcuts();
		}
		function OnSelection(code) {
			try {
					if ("gmodinterface" in window) {
							gmodinterface.OnSelection(code);
					}
			} catch (err) {
					console.log("ERR OnSelection: "+err);
			}
		}
		function GetSelection() {
			var s=editor.getSession();
			var r=s.getSelection().getRange();
			var txt=s.getTextRange(r);
			OnSelection(txt);
		}
		function ReplaceSelection(txt) {
			var s=editor.getSession();
			var r=s.getSelection().getRange();
			s.replace(r,txt || "");
		}

		// js->lua
		function OnReady() {
			try {
					editor.focus();

					editor.getSession().on('change', function(){
							var text = editor.getSession().getValue();
							OnCode(text);
					});


					if ("gmodinterface" in window) {
							gmodinterface.OnReady();
					} else {
							
							var gen = function(name) {
								return function() {
									console.log(name+": "+JSON.stringify(arguments));
								}
							};
							if (DEBUG) {
								window.gmodinterface = {
									OnSelection: gen("OnSelection"),
									OnReady: gen("OnReady"),
									OnLog: gen("OnLog"),
									OnCode: function(code) { gen("code")(code.length); },
									GetOptions: gen("GetOptions")
									
								};
								gmodinterface.OnReady();
							};
							
							console.log("GMod Interface Not Found!?");
					}

			} catch (err) {
					console.log("ERR OnReady: "+err);
			}

		}

		function OnCode(code) {
			try {
					if ("gmodinterface" in window) {
							gmodinterface.OnCode(code);
					}
			} catch (err) {
					console.log("ERR OnCode: "+err);
			}
		}

		function OnLog(logstr) {
			try {
					gmodinterface.OnLog(logstr);
			} catch (err) {
					console.log("FALLBACK LOG: "+err);
			}
		}

		document.addEventListener('DOMContentLoaded',OnReady);

</script>
</body>
</html>
